<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>use.perl.org journal of chromatic: Trace  Your Ops</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="/static/css/bootstrap.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the
bottom of the topbar */
      }
    </style>
    <link href="/static/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script
src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="/static/ico/favicon.ico">
  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse"
data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/"><img src="/static/img/slashhead.png"/></a>
          <div class="nav-collapse">
            <ul class="nav">
              <li><a href="/">Home</a></li>
              <li><a href="/about/">About</a></li>
              <li><a href="/authors/">Authors</a></li>
              <li><a href="/journals/">Journals</a></li>
              <li><a href="/stories/">Stories</a></li>
            </ul>
            <p class="navbar-text">All the Perl that's Practical to Extract and Report</p>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>



<div class="container">

<div class="row">

<div class="span4">
<h1>Trace  Your Ops</h1>
<h2><a href="/user/chromatic/">chromatic</a> on 2005-10-06T02:12:17</h2>
</div> <!-- /span4 -->


<div class="span8">
<p><p>I've been writing some weird code lately.</p>

<p>As I was falling asleep last night, I thought about pluggable runloops and figured out a way to instrument the standard runloop in such a way as to provide loads of debugging information to pure-Perl code written by people who don't want to have to dive into XS to learn interesting things.</p>

<p>Perl, not generating machine code directly, has a runloop that takes the optree generated by the compiler and walks it in order.  It's a very simple subroutine in <em>run.c</em> that basically says "Call the function pointer of the current op, which returns the next op.  If that next op exists, repeat."</p>

<p>Instrumenting that turns out to be pretty easy.  The only tricky part is making sure that the tracing code doesn't itself get traced, which would lead to all sorts of infinite recursions.</p>

<p>Okay, another tricky part is making sure not to leave any residue of the calls to the tracing code on the stack without requiring that non-XS programmers always end their code with bare return statements.  (If you've ever used <code>call_method()</code>, you probably know that <code>G_VOID</code> doesn't cut it here.  I know that too, but I wasted a few minutes not <em>knowing</em> that.)</p>

<p>Anyway, here's <a href="http://wgz.org/chromatic/perl/Runops-Trace.tar.gz">Runops::Trace</a> 0.01.  It's not spectacular or even useful, but it totally works as a proof of concept.  There's a little more design to do on the user side, such as "Which parts of the op should the user be able to see?" and "How should users be able to trace certain ops but not others?", so let me know if you have any opinions.</p>

<p>If you don't care, I'll give you a moral for this story anyway: if you're poking at the Perl interpreter and your code doesn't segfault, it must be fairly correct.</p></p>


<hr/>



<h2>Ooh.</h2>
<h3><a href="/user/jesse/">jesse</a> on 2005-10-06T04:27:19</h3>
Even scarier and deeper than Devel::CallTrace



<h2>Re:</h2>
<h3><a href="/user/Aristotle/">Aristotle</a> on 2005-10-06T07:56:59</h3>
<p>Sounds much like one of <a href="http://use.perl.org/quotes.txt" title="perl.org">the quotes in the rotation here</a perl.org>:</p>

<blockquote>
  <div><p>I&#8217;m currently dodging core dumps falling from the sky, but I think I&#8217;m running in generally right direction&#8230; &#8211; Jarkko Hietaniemi</p></div>
</blockquote>

<p><nobr> <wbr></nobr><tt>:)</tt> </p>





</div> <!-- /span8 -->

</div> <!-- row -->
</div> <!-- /container -->



    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

  </body>
</html>

