<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>use.perl.org journal of TorgoX: Mature optimization</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="/static/css/bootstrap.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the
bottom of the topbar */
      }
    </style>
    <link href="/static/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script
src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="/static/ico/favicon.ico">
  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse"
data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/"><img src="/static/img/slashhead.png"/></a>
          <div class="nav-collapse">
            <ul class="nav">
              <li><a href="/">Home</a></li>
              <li><a href="/about/">About</a></li>
              <li><a href="/authors/">Authors</a></li>
              <li><a href="/journals/">Journals</a></li>
              <li><a href="/stories/">Stories</a></li>
            </ul>
            <p class="navbar-text">All the Perl that's Practical to Extract and Report</p>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>



<div class="container">

<div class="row">

<div class="span4">
<h1>Mature optimization</h1>
<h2><a href="/user/TorgoX/">TorgoX</a> on 2006-06-23T07:26:15</h2>
</div> <!-- /span4 -->


<div class="span8">
<p>Dear Log,
<p>At times, I say <em>no.</em>
<p>I take some little document, a little bit of text, and I want to
make a PDF.  I print to a PostScript file and then, before I run
ps2pdf, I note that the weensy text document has become a massive
PostScript document (on the way to being an not-quite-so-appalling
PDF).  I grit my teeth and ignore the absurd <a href=
 "http://interglacial.com/user/sburke/pub/prose/Turkey_City_Lexicon.html"
 >suboptimality of it all</a>.

<p>A while ago, I was fiddling around with the <a href=
 "http://interglacial.com/clock/about.html"
 >Chimes of the Clock of the Long Now</a>.  This is the bell chimes to
be rung out by some musical clockwork designed by Danny Hillis and
Brian Eno; it has ten bells (or will, once it's all put together), and
when the clock chimes, daily, it rings the bells in a different order,
in an order that occurs once in the 10,000 years that the clock is
supposed to last.

<p>After fiddling around with audio-format renderings of these chimes
(as generated by <a href=
 "http://interglacial.com/clock/LongNowChimes.pm"
 >my Perl implementation</a> of the permutator algorithm</a>) and
thought, for kicks, that I could try generating sheet music.  So I
poured a month's worth of the note-values into <a href=
 "http://www.pjb.com.au/muscript/"
 >a nice little music-typesetter program</a>...
<p>And it spits out <a href=
"http://interglacial.com/temp/07003.ps">a fifty KB file</a>.

<p>I twitch.  I say THIS CANNOT STAND.  The PS file contains
23KB of PostScript routines, that's fine.  But just this once,
it simply makes me batty that it takes  25KB of code to draw <em>every
page</em>, which contains really
only about 300 characters worth of information, which is actually the
output of an algorithm that can be completely implemented in less
than that much code.

<p>I say <em>just this once,</em> I will fix this, I will make it
not horrible.

<p>I decided to approach it as an exercise in extreeeeeme code
maintenance.

<p>I toss out the never-unused routines in the PostScript prolog.
I eliminate redundant parameter-passing.  I even find and fix a stack
leak!  I zig, and zag, and <em>zig again.</em>  I get it so that
you can typeset a whole page by just passing a list-of-lists of the
notes in the measures in each month.  And then I implement
Danny Hillis's permutator algorithm, and write tests for it, and an
assertion test, and have that call the typesetter routine, so you can
typeset a whole month's page by just calling
<code><i>year&nbsp;month</i>&nbsp;P</code> and <em>that</em> is not the
kinda compressy goodness you'd get from just gzipping your PostScript.

<p>Then typesetting all 10,000 years' worth of the music (well,
throwing in an extra millennium for fun) is just a
matter of calling:
<pre>2000 1 12999 {
   1 1 12     {
               1 index exch P
              } for
             }  for</pre>
<p>And the resulting document is 27KB.
<p>Therefore I win the Internet.

<p>But it turns out that some PostScript viewers (GhostView, etc)
aren't so thrilled with a tight loop that queues 132,000 pages at
once.  So I go back in and add some DSC stuff (friendlier for
random-access navigation of PS documents), altho that means generating
endless lines like this:

<pre>%%Page: 04011-01 133
4011 1 P
%%Page: 04011-02 134
4011 2 P
%%Page: 04011-03 135
4011 3 P
%%Page: 04011-04 136
4011 4 P
%%Page: 04011-05 137
4011 5 P
%%Page: 04011-06 138
4011 6 P</pre>

<p>But hey, about thirty bytes a page is... acceptable.  Especially
compared to PDF having an overhead of about a thousand times that.

<p>I am now <a href=
 "http://masculinehygiene.com/sburke/temp/LongNowChimes_PostScript.zip"
 >pleased</a>.

<p>This victorious optimization should hold me for a while.



<p>~ ~ ~
<p>A historical note: my introduction to PostScript,
sane, compact <em>good</em> PostScript, was
reading the output of Gisle Aas's
<a href=
 "http://search.cpan.org/src/SBURKE/HTML-Format-2.04/lib/HTML/FormatPS.pm"
 >HTML::FormatPS</a>,
and then a bit of looking at the output of
<a href="http://www.google.com/search?q=tek2ps">tek2ps</a>.

<p>That was well after all the good books about PostScript had been
written and fallen out of print, but sadly before
<a href=
 "http://www.rightbrain.com/pages/books.html"
 >they appeared online</a>.
</p>





</div> <!-- /span8 -->

</div> <!-- row -->
</div> <!-- /container -->



    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

  </body>
</html>

